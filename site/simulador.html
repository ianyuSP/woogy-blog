<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador Sísmico | WOOGY Blog</title>

    <link rel="stylesheet" href="../static/css/responsive.css">
    <link rel="stylesheet" href="../static/css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Estilos específicos del velocímetro y la gráfica comparativa -->
    <style>
        .sim-gauge-container {
            width: 100%;
            max-width: 650px;
            margin: 0 auto 25px auto;
            text-align: center;
        }

        .gauge-wrapper {
            width: 100%;
            max-width: 650px;
            margin: 0 auto;
        }

        .gauge-svg {
            width: 100%;
            height: auto;
            display: block;
        }

        .gauge-value {
            font-size: 18px;
            margin-top: 10px;
            font-weight: bold;
        }

        /* Contenedor de la gráfica comparativa */
        .sim-chart-container {
            width: 100%;
            max-width: 650px;
            margin: 0 auto 25px auto;
            text-align: center;
        }

        .sim-chart-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .sim-chart-subtitle {
            font-size: 0.85rem;
            color: #555;
            margin-bottom: 10px;
        }

        .sim-chart-svg {
            width: 100%;
            height: auto;
            display: block;
        }

        .sim-chart-axis {
            stroke: #bba89b;
            stroke-width: 2;
        }

        .sim-chart-tick {
            stroke: #bba89b;
            stroke-width: 1;
        }

        .sim-chart-tick-label {
            fill: #555;
            font-size: 9px;
        }

        .sim-bar {
            transition: height 0.6s ease-out, y 0.6s ease-out;
        }

        .sim-chart-legend {
            margin-top: 8px;
            font-size: 0.85rem;
            display: flex;
            justify-content: center;
            gap: 16px;
            flex-wrap: wrap;
        }

        .sim-chart-legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .sim-chart-legend-color {
            width: 14px;
            height: 14px;
            border-radius: 3px;
        }

        @media (max-width: 768px) {
            .gauge-wrapper {
                max-width: 95%;
            }
            .gauge-value {
                font-size: 16px;
            }
            .sim-chart-title {
                font-size: 0.95rem;
            }
            .sim-chart-subtitle {
                font-size: 0.8rem;
            }
        }
    </style>
</head>

<body>
    <header class="header">
        <nav class="navbar">
            <span class="logo">WOOGY</span>
            <div class="menu">
                <a href="home.html">Mi Blog</a>
                <a href="hechos_historicos.html">Hechos Históricos</a>
                <a href="educ_sis.html">Educación Sísmica</a>
                <a href="material_de_apoyo.html">Material de Apoyo</a>
            </div>
            <div class="social-icons">
                <i class="fa-brands fa-facebook"></i>
                <i class="fa-brands fa-github"></i>
                <i class="fa-solid fa-user"></i>
            </div>
        </nav>
    </header>

    <main class="content-wrapper">
        <section class="page-title-section">
            <div class="title-container">
                <h2>Simulador de Recomendaciones Sísmicas</h2>
                <p>
                    Este simulador está enfocado en Iztapalapa, una zona con suelos blandos donde los sismos
                    se amplifican. Las recomendaciones se basan en protocolos oficiales adaptados a este contexto.
                </p>
            </div>
        </section>

        <section class="article-section">
            <div class="sim-box" id="sim-box">

                <h3 class="sim-title">Datos del Sismo</h3>

                <form id="sim-form" class="sim-form">

                    <div class="sim-field">
                        <label class="sim-label">Magnitud del sismo:</label>
                        <input
                            type="number"
                            id="magnitude"
                            class="sim-input"
                            min="1"
                            max="10"
                            step="0.1"
                            placeholder="Ej. 7.5">
                    </div>

                    <div class="sim-field">
                        <label class="sim-label">Planta en la que te encuentras:</label>
                        <select id="floor" class="sim-select">
                            <option value="baja">Planta baja</option>
                            <option value="media">Piso medio</option>
                            <option value="alta">Piso alto</option>
                        </select>
                    </div>

                    <div class="sim-field">
                        <label class="sim-label">Tipo de movimiento:</label>
                        <select id="movement" class="sim-select">
                            <option value="oscilatorio">Oscilatorio</option>
                            <option value="trepidatorio">Trepidatorio</option>
                            <option value="mixto">Mixto</option>
                        </select>
                    </div>

                    <button type="button" class="all-posts-btn sim-btn" id="sim-submit">
                        Generar recomendación
                    </button>

                </form>

            </div>
        </section>

    </main>

    <footer class="main-footer">
        <div class="footer-content">
            <div class="footer-section about">
                <h3>Acerca del Blog</h3>
                <p>Un espacio dedicado a la seguridad, la prevención sísmica y la resiliencia comunitaria.</p>
            </div>
            <div class="footer-section links">
                <h3>Enlaces Rápidos</h3>
                <ul>
                    <li><a href="home.html">Mi Blog</a></li>
                    <li><a href="documento-prototipico.pdf" target="_blank">Documento Prototípico</a></li>
                    <li><a href="politica_privacidad.html">Política de Privacidad</a></li>
                </ul>
            </div>
            <div class="footer-section contact">
                <h3>Atención Ciudadana</h3>
                <p>Teléfono: 55 1519 1864</p>
                <p>Emergencias: 55 5683 2222</p>
                <p>Correo: atencion.ciudadana.sgirpc@cdmx.gob.mx</p>
            </div>
        </div>

        <div class="footer-bottom">
            <p>*Derechos Reservados © 2025 UNRC* | Parte del
                <a class="prototipico-link" href="documento-prototipico.pdf" target="_blank">Proyecto Prototípico</a></p>
        </div>
    </footer>

<script>
(function () {
    const simBox = document.getElementById("sim-box");
    const originalBoxHTML = simBox.innerHTML;

    const API_URL = "https://woogy-backend-pp.onrender.com/simular";

    function getColorHex(colorName) {
        switch (colorName) {
            case "verde":    return "#2ecc71";
            case "amarillo": return "#f1c40f";
            case "naranja":  return "#e67e22";
            case "rojo":     return "#e74c3c";
            default:         return "#2ecc71";
        }
    }

    // Índices fijos para 1985 y 2017 (0–10)
    const INDEX_1985 = 9.5;  // Sismo 8.1, daños extremos
    const INDEX_2017 = 8.0;  // Sismo 7.1, daños altos pero algo menores

    // Índice global para la simulación (0–10) en función de la magnitud
    function computeSimulationIndex(mag) {
        if (mag < 1) return 0;
        if (mag < 3) return 2;
        if (mag < 4) return 4;
        if (mag < 6) return 6;
        if (mag < 7) return 8;
        if (mag <= 10) return 9.5;
        return 0;
    }

    function configurarFormulario() {
        const btn = document.getElementById("sim-submit");
        if (!btn) return;

        btn.addEventListener("click", async () => {
            const magInput = document.getElementById("magnitude");
            const floorSelect = document.getElementById("floor");
            const movementSelect = document.getElementById("movement");

            const magnitude = parseFloat(magInput.value);
            const floor = floorSelect.value;
            const movement = movementSelect.value;

            if (isNaN(magnitude)) {
                alert("Ingresa una magnitud válida entre 1.0 y 10.0.");
                return;
            }

            simBox.innerHTML = `
                <h3 class="sim-title">Generando recomendación...</h3>
                <div class="sim-loading">
                    <span class="dot"></span><span class="dot"></span><span class="dot"></span>
                </div>
                <p class="sim-helper-text">
                    Analizando la magnitud, la planta y el tipo de movimiento según Iztapalapa.
                </p>
            `;

            try {
                await new Promise(resolve => setTimeout(resolve, 500));

                const response = await fetch(API_URL, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        magnitude: magnitude,
                        floor: floor,
                        movement: movement
                    })
                });

                const data = await response.json().catch(() => ({}));

                if (!response.ok) {
                    simBox.innerHTML = `
                        <h3 class="sim-title">Ocurrió un problema</h3>
                        <p class="sim-text">${data.error || "No fue posible obtener la recomendación."}</p>
                        <button type="button" class="all-posts-btn sim-btn-restart">
                            Volver al simulador
                        </button>
                    `;
                    simBox.querySelector(".sim-btn-restart").addEventListener("click", () => {
                        simBox.innerHTML = originalBoxHTML;
                        configurarFormulario();
                    });
                    return;
                }

                const recommendation = data.recomendacion;
                const nivel = data.nivel;
                const intervalo = data.intervalo;
                const strokeColor = getColorHex(data.color);
                const needleAngle = -90 + (magnitude - 1) * (180 / 9);

                // Índice global para la simulación (0–10)
                const indexSim = computeSimulationIndex(magnitude);

                // Parámetros de la gráfica de barras
                const maxIndex = 10;
                const chartTopY = 30;
                const chartBottomY = 210;
                const chartHeight = chartBottomY - chartTopY;

                function barY(val) {
                    const clamped = Math.max(0, Math.min(maxIndex, val));
                    return chartBottomY - (clamped / maxIndex) * chartHeight;
                }

                const y1985 = barY(INDEX_1985);
                const y2017 = barY(INDEX_2017);
                const ySim = barY(indexSim);

                const h1985 = chartBottomY - y1985;
                const h2017 = chartBottomY - y2017;
                const hSim = chartBottomY - ySim;

                simBox.innerHTML = `
                    <h3 class="sim-title">Recomendación Sísmica</h3>
                    <p class="sim-text">${recommendation}</p>

                    <!-- VELOCÍMETRO -->
                    <div class="sim-gauge-container">
                        <h4 class="sim-subtitle">
                            Nivel de riesgo: <span class="sim-risk-level">${nivel.toUpperCase()}</span>
                            <span class="sim-risk-interval">(${intervalo})</span>
                        </h4>

                        <div class="gauge-wrapper">
                            <svg viewBox="0 0 300 170" class="gauge-svg">
                                <!-- Arco base -->
                                <path d="M20 150 A130 130 0 0 1 280 150"
                                      stroke="#222" stroke-width="22" fill="none" stroke-linecap="round"/>

                                <!-- Tramo verde -->
                                <path d="M20 150 A130 130 0 0 1 110 40"
                                      stroke="#2ecc71" stroke-width="16" fill="none" stroke-linecap="round"/>

                                <!-- Tramo amarillo -->
                                <path d="M110 40 A130 130 0 0 1 170 40"
                                      stroke="#f1c40f" stroke-width="16" fill="none" stroke-linecap="round"/>

                                <!-- Tramo rojo -->
                                <path d="M170 40 A130 130 0 0 1 280 150"
                                      stroke="#e74c3c" stroke-width="16" fill="none" stroke-linecap="round"/>

                                <!-- Aguja -->
                                <line id="gauge-needle"
                                      x1="150" y1="150" x2="150" y2="45"
                                      stroke="${strokeColor}"
                                      stroke-width="6"
                                      stroke-linecap="round"
                                      transform="rotate(${needleAngle},150,150)"/>

                                <!-- Centro -->
                                <circle cx="150" cy="150" r="9" fill="#333"/>
                            </svg>

                            <div class="gauge-value">
                                Magnitud: ${magnitude.toFixed(1)}
                            </div>
                        </div>
                    </div>

                    <!-- GRÁFICA COMPARATIVA -->
                    <div class="sim-chart-container">
                        <h4 class="sim-chart-title">Gráfica comparativa de sismos</h4>
                        <p class="sim-chart-subtitle">
                            Índice global de impacto (0 = impacto casi nulo, 10 = impacto extremo).
                        </p>

                        <svg viewBox="0 0 360 240" class="sim-chart-svg">
                            <!-- Ejes -->
                            <line x1="50" y1="${chartTopY}" x2="50" y2="${chartBottomY}" class="sim-chart-axis"/>
                            <line x1="50" y1="${chartBottomY}" x2="330" y2="${chartBottomY}" class="sim-chart-axis"/>

                            <!-- Ticks y etiquetas 0,2,4,...,10 -->
                            ${[0,2,4,6,8,10].map(v => {
                                const y = chartBottomY - (v / maxIndex) * chartHeight;
                                return `
                                    <line x1="46" y1="${y}" x2="50" y2="${y}" class="sim-chart-tick"/>
                                    <text x="42" y="${y + 3}" class="sim-chart-tick-label" text-anchor="end">${v}</text>
                                `;
                            }).join("")}

                            <!-- Etiquetas en el eje X -->
                            <text x="110" y="${chartBottomY + 15}" class="sim-chart-tick-label" text-anchor="middle">1985</text>
                            <text x="190" y="${chartBottomY + 15}" class="sim-chart-tick-label" text-anchor="middle">2017</text>
                            <text x="270" y="${chartBottomY + 15}" class="sim-chart-tick-label" text-anchor="middle">Simulación</text>

                            <!-- Barras -->
                            <rect x="90" y="${y1985}" width="30" height="${h1985}"
                                  fill="#e74c3c" class="sim-bar"/>
                            <rect x="170" y="${y2017}" width="30" height="${h2017}"
                                  fill="#3498db" class="sim-bar"/>
                            <rect x="250" y="${ySim}" width="30" height="${hSim}"
                                  fill="#2ecc71" class="sim-bar"/>
                        </svg>

                        <!-- Leyenda -->
                        <div class="sim-chart-legend">
                            <div class="sim-chart-legend-item">
                                <span class="sim-chart-legend-color" style="background:#e74c3c;"></span>
                                <span>1985 · Sismo M8.1</span>
                            </div>
                            <div class="sim-chart-legend-item">
                                <span class="sim-chart-legend-color" style="background:#3498db;"></span>
                                <span>2017 · Sismo M7.1</span>
                            </div>
                            <div class="sim-chart-legend-item">
                                <span class="sim-chart-legend-color" style="background:#2ecc71;"></span>
                                <span>Simulación · Magnitud ingresada</span>
                            </div>
                        </div>
                    </div>

                    <button type="button" class="all-posts-btn sim-btn-restart">
                        Nueva simulación
                    </button>
                `;

                simBox.querySelector(".sim-btn-restart").addEventListener("click", () => {
                    simBox.innerHTML = originalBoxHTML;
                    configurarFormulario();
                });

            } catch (err) {
                simBox.innerHTML = `
                    <h3 class="sim-title">Ocurrió un problema</h3>
                    <p class="sim-text">No fue posible obtener la recomendación.</p>
                    <button type="button" class="all-posts-btn sim-btn-restart">
                        Volver al simulador
                    </button>
                `;
                simBox.querySelector(".sim-btn-restart").addEventListener("click", () => {
                    simBox.innerHTML = originalBoxHTML;
                    configurarFormulario();
                });
            }
        });
    }

    configurarFormulario();
})();
</script>

</body>
</html>
